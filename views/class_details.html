<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/teacher-dashboard">Teacher Portal</a>
            <a href="/logout" class="btn btn-light">Logout</a>
        </div>
    </nav>

    <div class="container py-5">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/teacher-dashboard">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page" id="class-breadcrumb-name">Loading...</li>
            </ol>
        </nav>
        <h1 id="class-title">Loading Class...</h1>
        <p class="lead" id="course-subtitle"></p>

        <hr class="my-4">

        <!-- Assignments Section -->
        <div class="row">
            <div class="col-md-5">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Create New Assignment</h5>
                        <form id="assignment-form" action="" method="POST" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="assignment-title" class="form-label">Title</label>
                                <input type="text" class="form-control" id="assignment-title" name="title" required>
                            </div>
                            <div class="mb-3">
                                <label for="assignment-description" class="form-label">Description</label>
                                <textarea class="form-control" id="assignment-description" name="description" rows="3"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="due-date" class="form-label">Due Date</label>
                                    <input type="date" class="form-control" id="due-date" name="dueDate" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="due-time" class="form-label">Due Time</label>
                                    <input type="time" class="form-control" id="due-time" name="dueTime" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="assignmentFiles" class="form-label">Assignment Files (Optional)</label>
                                <input class="form-control" type="file" id="assignmentFiles" name="assignmentFiles" multiple>
                            </div>
                            <button type="submit" class="btn btn-primary">Post Assignment</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <h3>Assignments</h3>
                <div class="list-group" id="assignments-list">
                    <!-- Assignments will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <hr class="my-5">

        <div class="row">
            <div class="col-md-5">
                <div class="card shadow-sm mb-5">
                    <div class="card-body">
                        <h5 class="card-title">Upload New Material</h5>
                        <form id="upload-form" method="POST" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="title" class="form-label">Material Title</label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label">Description (Optional)</label>
                                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="material-files" class="form-label">Files</label>
                                <input class="form-control" type="file" id="material-files" name="materialFiles" multiple required>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-7">
                <h3>Uploaded Materials</h3>
                <ul class="list-group" id="materials-list"></ul>
                <h3 class="mt-5">Enrolled Students</h3>
                <ul class="list-group" id="student-list"></ul>
            </div>
        </div>
    </div>

    <script>
        const classId = window.location.pathname.split('/').pop();
        const uploadForm = document.getElementById('upload-form');
        uploadForm.action = `/class/${classId}/upload`;
        const assignmentForm = document.getElementById('assignment-form');
        assignmentForm.action = `/class/${classId}/create-assignment`;

        async function fetchClassDetails() {
            try {
                const response = await fetch(`/api/teacher/class/${classId}`);
                const classDetails = await response.json();
                document.getElementById('class-breadcrumb-name').textContent = classDetails.class_name;
                document.getElementById('class-title').textContent = classDetails.class_name;
                document.getElementById('course-subtitle').textContent = classDetails.course_name;
            } catch (error) {
                console.error('Failed to fetch class details:', error);
            }
        }

        async function fetchMaterials() {
            const materialsList = document.getElementById('materials-list');
            try {
                const response = await fetch(`/api/class/${classId}/materials`);
                const materials = await response.json();
                if (materials.length === 0) {
                    materialsList.innerHTML = '<li class="list-group-item">No materials have been uploaded yet.</li>';
                    return;
                }
                materialsList.innerHTML = '';
                materials.forEach(material => {
                    const listItem = `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="my-0">${material.title}</h6>
                                <small class="text-muted">${material.description || ''}</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <a href="/uploads/${material.file_path}" class="btn btn-sm btn-outline-primary me-2" download>Download</a>
                                <form action="/material/${material.material_id}/delete" method="POST" onsubmit="return confirm('Are you sure?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                </form>
                            </div>
                        </li>
                    `;
                    materialsList.innerHTML += listItem;
                });
            } catch (error) {
                console.error('Failed to fetch materials:', error);
            }
        }

        async function fetchEnrolledStudents() {
            const studentList = document.getElementById('student-list');
            try {
                const response = await fetch(`/api/class/${classId}/students`);
                const students = await response.json();
                if (students.length === 0) {
                    studentList.innerHTML = '<li class="list-group-item">No students have enrolled yet.</li>';
                    return;
                }
                studentList.innerHTML = '';
                students.forEach(student => {
                    const listItem = `<li class="list-group-item">${student.name} - ${student.email}</li>`;
                    studentList.innerHTML += listItem;
                });
            } catch (error) {
                console.error('Failed to fetch students:', error);
            }
        }

        async function fetchAssignments() {
            const assignmentsList = document.getElementById('assignments-list');
            try {
                const response = await fetch(`/api/class/${classId}/assignments`);
                const assignments = await response.json();
                if (assignments.length === 0) {
                    assignmentsList.innerHTML = '<li class="list-group-item">No assignments posted yet.</li>';
                    return;
                }
                assignmentsList.innerHTML = '';
                assignments.forEach(assignment => {
                    const dueDate = new Date(assignment.due_date).toLocaleString('en-US', { dateStyle: 'long', timeStyle: 'short' });
                    
                    let filesHtml = '';
                    if (assignment.files && assignment.files.length > 0) {
                        filesHtml = '<div class="mt-2">' + assignment.files.map(file => 
                            `<a href="/uploads/${file.file_path}" class="btn btn-sm btn-outline-secondary me-1" download="${file.original_name}">Download "${file.original_name.substring(0, 20)}..."</a>`
                        ).join('') + '</div>';
                    }

                    const listItem = `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <a href="/teacher/assignment/${assignment.assignment_id}" class="text-decoration-none text-dark flex-grow-1">
                                    <h6 class="mb-1">${assignment.title}</h6>
                                    <small>Due: ${dueDate}</small>
                                </a>
                                <form class="ms-3" action="/assignment/${assignment.assignment_id}/delete" method="POST" onsubmit="return confirm('Are you sure?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                                </form>
                            </div>
                            <p class="mb-1 text-muted small">${assignment.description || ''}</p>
                            ${filesHtml}
                        </div>
                    `;
                    assignmentsList.innerHTML += listItem;
                });
            } catch (error) {
                console.error('Failed to fetch assignments:', error);
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            fetchClassDetails();
            fetchMaterials();
            fetchEnrolledStudents();
            fetchAssignments();
        });
    </script>
</body>
</html>